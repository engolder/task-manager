# /pr-open 명령어 가이드

## 명령어 개요
`/pr-open` - PR 생성 자동화 명령어

자동으로 git 상태를 확인하고, 필요시 커밋 후 PR을 생성하는 명령어입니다.

## 실행 플로우
1. **Git 상태 확인**: `git status`, `git diff`, `git log` 실행
2. **기존 PR 확인**: `gh pr list --head [current-branch]`로 열린 PR 존재 여부 확인
3. **변경사항 분석**: 커밋이 필요한 변경사항 존재 여부 확인
4. **분기 처리**:
   - **기존 PR 존재**: 변경사항을 커밋하고 기존 PR에 푸시
   - **PR 없음**: 새로운 PR 생성 플로우 진행
5. **커밋 생성**: 필요시 변경사항 커밋 및 푸시
6. **PR 처리**: 
   - 기존 PR: 추가 커밋으로 업데이트
   - 새 PR: 본문 작성 후 생성

## Git 및 PR 관리 가이드라인

### 브랜치 전략
- 작업 내용을 1~4개의 영어 단어로 요약하여 브랜치명 결정
  - 예: `add-task-feature`
  - 예: `fix-auth-bug`
  - 예: `update-ui-components`
  - 예: `refactor-api-client`

### 커밋 및 브랜치 관리

#### 현재 브랜치 상태 확인
```bash
# 현재 브랜치 확인
git branch --show-current
```

#### 브랜치별 처리 방법
- **main 브랜치인 경우**: 새로운 브랜치 생성 후 작업 진행
- **기존 브랜치인 경우**: 
  1. main과의 관계 확인
  2. 열린 PR 존재 여부 확인
  3. 현재 변경사항이 기존 PR과 연관성 있는지 판단
  4. 필요시 새 브랜치 생성

### PR 생성 가이드라인

#### PR 제목 규칙
- 형식: "[작업 유형] 구체적인 작업 내용 설명"
- 작업의 의도와 영향을 명확하게 표현
- 예시:
  - ✅ "[Feature] Add drag-and-drop reordering to task list"
  - ✅ "[Fix] Prevent token expiration during active user session"
  - ❌ "[Feature] Update task feature"
  - ❌ "[Fix] Fix auth bug"

#### PR 본문 구조 템플릿
```bash
gh pr create \
  --title "[작업 유형] 작업 제목" \
  --body "## 작업 개요
- 목적: [작업의 주요 목적]
- 변경사항: [핵심 변경 내용]

## 주요 변경사항
- [구체적인 변경 내용들]
- [추가/수정된 파일들과 그 역할]

## 아키텍처/설계 결정 (필요한 경우만)
- 접근 방법: [선택한 방식]
- 선택 이유: [왜 이 방식을 선택했는지]" \
  --assignee "@me"
```

#### PR 본문 작성 원칙
- **최소한의 필수 정보만**: 작업 목적, 변경사항에 집중
- **불필요한 섹션 제거**: 사용법, 예시 코드, 보안/성능 고려사항 등은 포함하지 않음
- **간결하고 핵심만**: 3-5줄 내외로 간단명료하게 작성
- **상황에 맞게 조정**: 단순한 작업은 더욱 간단하게, 복잡한 작업만 설계 결정 포함

#### ⚠️ 커밋 및 PR 작성 시 필수 준수사항 ⚠️
**다음 문구들은 절대로 추가하지 않음:**
- ❌ `"🤖 Generated with [Claude Code](https://claude.ai/code)"` 문구
- ❌ `"Co-Authored-By: Claude <noreply@anthropic.com>"` 문구
- ❌ 기타 Claude 관련 메타 정보나 서명

**준수해야 할 원칙:**
- ✅ 커밋 메시지와 PR 본문은 깔끔하고 간결하게 작성
- ✅ 작업 내용만 명확히 설명
- ✅ 불필요한 메타 정보는 포함하지 않음
- ✅ 개발자가 직접 작성한 것처럼 자연스럽게 작성

**중요**: 이 규칙들은 모든 Git 작업 시 반드시 적용되어야 함

### PR 머지 정책
- 모든 PR은 반드시 squash 머지로 진행
- 머지 후 로컬/원격 브랜치 자동 삭제
```bash
gh pr merge [PR번호] --squash --delete-branch
```

## /pr-open 실행 단계별 로직

### 1. Git 상태 분석
```bash
# 병렬 실행으로 Git 정보 수집
git status
git diff
git log --oneline -5
gh pr list --head $(git branch --show-current)
```

**분석 항목:**
- Untracked files 존재 여부
- Modified files 존재 여부  
- Staged files 존재 여부
- 현재 브랜치명
- 최근 커밋 히스토리
- 현재 브랜치의 열린 PR 존재 여부

### 2. PR 상태 확인 및 분기
**기존 PR이 존재하는 경우:**
- PR 정보 표시 (제목, URL, 상태)
- "기존 PR에 변경사항을 추가하겠습니다" 안내
- 커밋 후 푸시하여 기존 PR 업데이트
- PR 본문 재생성 과정 생략

**기존 PR이 없는 경우:**
- 새로운 PR 생성 플로우 진행
- PR 본문 자동 생성 및 사용자 승인 과정 수행

### 3. 커밋 필요성 판단
**커밋이 필요한 경우:**
- Untracked files 또는 Modified files가 존재
- 작업 내용이 완료되어 PR 생성/업데이트 준비됨

**커밋하지 않는 경우:**
- Working tree clean 상태
- 사용자가 명시적으로 거부한 경우

### 4. 자동 커밋 메시지 생성 규칙
**변경된 파일 분석 기반:**
- 새 파일 생성: "Add [파일명/기능명]"
- 기존 파일 수정: "Update [파일명/기능명]"
- 파일 삭제: "Remove [파일명/기능명]"
- 여러 파일 변경: 주요 변경사항을 요약

**커밋 메시지 구조:**
```
[작업 유형] 간결한 변경 내용 요약

- 구체적인 변경사항 1
- 구체적인 변경사항 2
- 구체적인 변경사항 3
```

### 5. PR 본문 자동 생성
**변경사항 기반 분석:**
- `git diff --name-status`로 파일 변경 유형 파악
- 추가/수정/삭제된 파일별 역할 분석
- 주요 기능이나 컴포넌트 식별

**학습된 개선사항 반영:**
- "학습된 개선사항" 섹션의 피드백 패턴을 PR 본문 생성 시 적용
- 이전 거절 사유와 유사한 상황에서는 학습된 패턴으로 개선된 본문 생성
- 사용자 관점 우선, 기술적 세부사항 최소화

**PR 본문 자동 생성 템플릿:**
```markdown
## 작업 개요
- 목적: [변경사항을 기반으로 추론된 작업 목적]
- 변경사항: [핵심 변경 내용 요약]

## 주요 변경사항
- [파일명]: [변경 내용과 역할]
- [파일명]: [변경 내용과 역할]

## 아키텍처/설계 결정
[복잡한 변경사항인 경우에만 추가]
- 접근 방법: [선택한 방식]
- 선택 이유: [선택 이유]
```

**거절 사유 반영 로직:**
1. 사용자가 거절 사유 입력 시 해당 내용을 "학습된 개선사항" 섹션에 추가
2. 거절 사유를 분석하여 PR 본문의 문제점 파악
3. 학습된 패턴을 적용하여 개선된 PR 본문 재생성
4. 최대 3회까지 재생성 시도, 그 이후에는 수동 수정 옵션 제공

### 6. 사용자 승인 프로세스
1. **PR 제목 제시**: 자동 생성된 제목을 사용자에게 제시
2. **PR 본문 제시**: 자동 생성된 본문을 사용자에게 제시
3. **Claude Code 승인 요청**: 기본 approve/reject 기능 사용
4. **거절 처리**: 사용자가 reject하면서 개선 사유를 제시하는 경우
   - **1단계**: 거절 사유를 pr-open.md의 "학습된 개선사항" 섹션에 즉시 추가
   - **2단계**: "📚 피드백을 학습하여 pr-open.md를 업데이트했습니다." 메시지 출력
   - **3단계**: 업데이트된 학습 패턴을 반영하여 PR 본문 재생성
   - **4단계**: 개선된 본문으로 다시 승인 요청 (거절 시 1단계부터 반복)
5. **최종 확인**: approve 시 PR 생성, reject 시 학습 프로세스 반복

#### ⚠️ 거절 처리 시 필수 준수사항 ⚠️
**거절 사유 처리 순서를 반드시 지킬 것:**
- ❌ 바로 PR 본문 재생성하지 말 것
- ✅ 반드시 먼저 pr-open.md 학습 업데이트 → 메시지 출력 → 그 다음 재생성

### 7. 에러 처리 및 예외 상황

#### Git 상태 예외
- **Clean working tree**: 커밋할 변경사항이 없음을 알리고 종료
- **Merge conflict**: 충돌 해결 필요 안내
- **Detached HEAD**: 브랜치 체크아웃 필요 안내

#### PR 생성 예외
- **GitHub 인증 오류**: `gh auth` 설정 안내
- **네트워크 오류**: 재시도 안내
- **브랜치 동기화 오류**: 원격 브랜치와 충돌 시 해결 방법 안내

#### 브랜치 관리 예외
- **main 브랜치에서 작업**: 새 브랜치 생성 제안
- **원격과 동기화 안됨**: push 필요성 안내

#### PR 본문 거절 처리
- **최대 재시도 횟수 초과**: 3회 거절 후 수동 수정 모드로 전환
- **학습 실패**: 거절 사유가 모호하거나 분석 불가능한 경우 명확한 사유 재요청
- **피드백 저장 실패**: pr-open.md 업데이트 권한 문제 시 임시 메모리에 저장 후 안내

## 사용 예시

### 기본 사용
```bash
/pr-open
```

### 실행 결과 예시

#### 기존 PR이 있는 경우
```
📊 Git 상태 확인 중...
🔍 기존 PR 확인 중...
✅ 열린 PR 발견: #42 "[Feature] Add user authentication system"
   URL: https://github.com/username/repo/pull/42
📝 3개 파일 변경사항 감지

기존 PR에 변경사항을 추가하겠습니다.

커밋 메시지:
[Feature] Add password validation and error handling

- 비밀번호 강도 검증 로직 추가
- 로그인/회원가입 에러 메시지 표시
- 폼 입력 검증 개선

✅ 커밋 완료 및 PR #42 업데이트됨
```

#### 새로운 PR 생성 플로우
```
📊 Git 상태 확인 중...
🔍 기존 PR 확인 중...
❌ 현재 브랜치에 열린 PR 없음
✅ 3개 파일 변경사항 감지
📝 커밋 생성 중...
🚀 PR 본문 생성 중...

=== PR 미리보기 ===
제목: [Feature] Add user authentication system

본문:
## 작업 개요
- 목적: 사용자 로그인/회원가입 기능 구현
- 변경사항: JWT 기반 인증 시스템 추가

## 주요 변경사항
- auth.js: JWT 토큰 생성 및 검증 로직
- login.jsx: 로그인 폼 컴포넌트
- signup.jsx: 회원가입 폼 컴포넌트

이 내용으로 PR을 생성하겠습니다.
```

#### 거절 및 학습 플로우
```
=== PR 미리보기 ===
제목: [Feature] Add user authentication system

본문:
## 작업 개요
- 목적: 사용자 로그인/회원가입 기능 구현
- 변경사항: JWT 기반 인증 시스템 추가

## 주요 변경사항
- auth.js: JWT 토큰 생성 및 검증 로직
- login.jsx: 로그인 폼 컴포넌트  
- signup.jsx: 회원가입 폼 컴포넌트

이 내용으로 PR을 생성하겠습니다.

[사용자가 reject 선택 시]
PR 생성이 거절되었습니다. 개선 사유를 알려주시면 더 나은 PR 본문을 생성하겠습니다.

개선 사유: 기술적 구현 세부사항이 너무 많고, 사용자 관점에서의 기능 설명이 부족함

📚 피드백을 학습하여 pr-open.md를 업데이트했습니다.
🔄 개선된 PR 본문을 생성 중...

=== 개선된 PR 미리보기 ===
제목: [Feature] Add user authentication system

본문:
## 작업 개요
- 목적: 사용자 로그인/회원가입 기능 구현
- 변경사항: 회원가입, 로그인, 로그아웃 기능 추가

## 주요 변경사항
- 사용자 회원가입 및 로그인 폼 구현
- JWT 기반 인증 시스템 구축
- 사용자 세션 관리 기능 추가

이 개선된 내용으로 PR을 생성하겠습니다.
```

## 학습된 개선사항

### PR 본문 작성 시 피드백 히스토리
이 섹션은 사용자 피드백을 바탕으로 자동 업데이트됩니다.

**피드백 학습 규칙:**
1. 사용자가 거절 사유를 제시하면 해당 내용을 아래에 기록
2. 동일한 유형의 피드백이 반복되면 패턴을 인식하여 자동 생성 로직에 반영
3. 성공적인 승인 패턴도 학습하여 더 나은 PR 본문 생성

**학습된 개선 패턴:**
- 기술적 세부사항보다 사용자 관점의 기능 설명 우선
- 구현 세부사항은 간결하게, 전체적인 목적과 효과에 집중
- 파일별 변경사항은 기술적 용어보다 기능적 설명 사용
- 단순한 기능 추가나 문서 작업에는 아키텍처/설계 결정 섹션 불필요
- 작업의 복잡도에 맞게 섹션 구성 - 단순하면 최소한으로만

*이 섹션은 사용자 피드백에 따라 지속적으로 업데이트됩니다.*